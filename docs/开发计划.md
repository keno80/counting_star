# 开发计划｜记账软件（Kotlin 原生）

本计划依据 [PRD.md](file:///e:/Code/counting_star/docs/PRD.md) 与 [功能清单.md](file:///e:/Code/counting_star/docs/%E5%8A%9F%E8%83%BD%E6%B8%85%E5%8D%95.md) 拆分任务，所有初始任务状态均为未完成。

## 0. 约定与范围

### 0.1 平台与技术建议（可按项目实际调整）

- 平台：Android（Kotlin 原生）
- UI：Jetpack Compose（或 XML 视图体系，二选一）
- 架构：MVVM + 单向数据流（UI State / Event / Effect）
- 异步：Kotlin Coroutines + Flow
- 数据库：Room（本地离线优先）
- 设置存储：DataStore（偏好设置）
- 依赖注入：Hilt（可选）
- 图表：Compose Chart 库或自绘（可选）
- 导出/备份：文件读写 + SAF（Storage Access Framework）

### 0.2 版本与里程碑映射

- M1（P0）：基础数据结构 + 记一笔 + 列表
- M2（P0）：统计（概览/分类）+ CSV 导出 + 备份/恢复
- M3（P1）：预算 + 模板/批量/体验增强
- M4（P2）：同步/协作/自动化/安全增强

## 1. 项目初始化与工程基建（Epic）

### 1.1 工程创建与构建配置

- [x] 新建 Android 项目（Kotlin）
- [x] 配置 build variants（debug/release）
- [x] 配置签名与打包策略（debug key / release key）
- [x] 配置版本号策略（versionCode/versionName）
- [x] 配置 Proguard/R8（release）
- [x] 配置多渠道（可选）

### 1.2 依赖与模块划分

- [x] 确定 UI 技术栈（Compose 或 XML）
- [x] 引入协程与 Flow 依赖
- [x] 引入 Room（entity/dao/database）依赖
- [x] 引入 DataStore（preferences）依赖
- [x] 引入导航框架（Compose Navigation 或 Fragment Navigation）
- [x] 引入 JSON 序列化库（备份文件需要；如 kotlinx.serialization）
- [x] 引入日期时间处理（java.time，Android desugaring）
- [x] 引入 DI（Hilt，可选）并完成初始化
- [x] 规划模块（可选）：app / core / data / domain / feature-xxx

### 1.3 架构与编码规范

- [x] 定义分层边界（UI / domain / data）→ [架构规范.md](架构规范.md)
- [x] 定义状态管理规范（UiState/UiEvent/UiEffect）→ [状态管理规范.md](状态管理规范.md)
- [x] 定义错误处理规范（Result/Either/异常映射）→ [错误处理规范.md](错误处理规范.md)
- [x] 定义日志规范（debug 日志/ release 关闭）→ [日志规范.md](日志规范.md)
- [x] 定义时间与币种精度策略（金额用“分”整型）→ [时间与币种精度策略.md](时间与币种精度策略.md)
- [x] 定义数据库迁移策略（Room migration）→ [数据库迁移策略.md](数据库迁移策略.md)

### 1.4 质量与自动化

- [ ] 接入静态检查（ktlint/detekt，二选一或都用）
- [ ] 配置单元测试框架（JUnit）
- [ ] 配置协程测试工具（kotlinx-coroutines-test）
- [ ] 配置 Room 测试（inMemory db）
- [ ] 配置 UI 测试（Compose UI test / Espresso，可选）
- [ ] 配置 CI（可选）：构建 + 单测 + 静态检查

### 1.5 设计资产（可选）

- [ ] 主题体系（浅色/深色）
- [ ] 字体与字号规范
- [ ] 图标与颜色体系（分类/标签可复用）

## 2. 核心数据模型与本地存储（Epic）

### 2.1 数据模型定义（与 PRD 对齐）

- [ ] 定义 Ledger（账本）实体字段
- [ ] 定义 Account（账户）实体字段（含信用卡可选字段）
- [ ] 定义 Category（分类）实体字段（收入/支出、两级）
- [ ] 定义 Tag（标签）实体字段
- [ ] 定义 Merchant（商家）实体字段
- [ ] 定义 Transaction（流水）实体字段（income/expense/transfer）
- [ ] 定义 TransactionSplit（拆分明细）实体字段（P0/P1 分阶段）
- [ ] 定义 BackupRecord（备份记录）实体字段（可放 DataStore 或 DB）
- [ ] 定义枚举与常量（账户类型、流水类型、分类类型）

### 2.2 Room 表结构与 DAO

- [ ] 建立 Room Database
- [ ] LedgerDao：增删改查 + 默认账本查询
- [ ] AccountDao：增删改查 + 启用/停用 + 余额更新
- [ ] CategoryDao：增删改查 + 排序 + 置顶 + 级联查询
- [ ] TagDao：增删改查 + 关联查询（按流水）
- [ ] MerchantDao：增删改查 + 名称搜索/联想
- [ ] TransactionDao：增删改查 + 条件查询（时间/金额/账户/分类/标签/商家/关键字）
- [ ] TransactionDao：分页/流式加载支持（Paging 可选）
- [ ] TransactionSplitDao：增删改查 + 汇总校验（如启用）
- [ ] 设计索引（occurredAt、accountId、categoryId、merchantId）

### 2.3 Repository 与 UseCase（Domain）

- [ ] Repository 接口定义（ledger/account/category/tag/merchant/transaction）
- [ ] 实现本地数据源（Room）
- [ ] UseCase：新增收入/支出
- [ ] UseCase：新增转账
- [ ] UseCase：编辑流水（差量回滚/重算策略落地）
- [ ] UseCase：删除流水（MVP 硬删除；P1 软删除）
- [ ] UseCase：流水查询（筛选/搜索/排序）
- [ ] UseCase：统计汇总（收入/支出/结余、分类聚合）
- [ ] UseCase：导出 CSV
- [ ] UseCase：备份与恢复

### 2.4 余额一致性策略（关键难点）

- [ ] 明确“余额更新”模式（A：差量更新；B：基于流水重算）
- [ ] 实现新增流水后的余额变更逻辑
- [ ] 实现编辑流水的余额校正逻辑
- [ ] 实现删除流水的余额校正逻辑
- [ ] 增加一致性校验工具（开发调试用，可选）

### 2.5 默认数据与初始化

- [ ] 首次启动：创建默认账本
- [ ] 初始化默认分类（收入/支出两套）
- [ ] 初始化默认账户（现金）
- [ ] 初始化默认标签（可选）
- [ ] 设置默认偏好（默认账本/默认账户）

## 3. 导航与基础页面骨架（Epic）

### 3.1 路由与页面结构

- [ ] 定义导航图（首页/记一笔/流水/统计/账户/管理/数据/设置）
- [ ] 搭建底部导航（首页、流水、统计、设置/更多）
- [ ] 全局 Snackbar/Toast 错误提示能力
- [ ] 全局 Loading 状态与空状态组件

### 3.2 组件库（复用组件）

- [ ] 金额输入组件（数字键盘/格式化/小数控制）
- [ ] 日期时间选择组件
- [ ] 分类选择器（两级）
- [ ] 账户选择器（列表 + 余额）
- [ ] 标签多选组件
- [ ] 商家输入与联想组件
- [ ] 筛选面板组件（账户/分类/标签/日期/金额）
- [ ] 列表分组头（按日/按月）

## 4. 记一笔（P0 核心）(Epic)

### 4.1 记一笔页面（收入/支出/转账）

- [ ] 页面布局：类型切换（支出/收入/转账）
- [ ] 金额输入（必填、>0、精度限制）
- [ ] 支出/收入：账户选择（必填）
- [ ] 支出/收入：分类选择（必填）
- [ ] 转账：转出账户选择（必填）
- [ ] 转账：转入账户选择（必填且不同）
- [ ] 日期时间选择（默认当前时间）
- [ ] 备注输入
- [ ] 标签多选（P0 可先做，或 P1）
- [ ] 商家输入（P0 可先做简单文本，P1 再联想）
- [ ] 保存按钮状态（校验通过才可点击）

### 4.2 保存逻辑与用例接入

- [ ] 构建 UiState（字段、校验状态、错误信息）
- [ ] 触发保存事件（UiEvent）
- [ ] 调用新增流水 UseCase
- [ ] 保存成功：返回上一页并提示成功
- [ ] 保存失败：展示错误信息并允许重试

### 4.3 记一笔体验增强（P1 可选）

- [ ] 复制上一笔（预填字段）
- [ ] 常用模板（快捷填充分类/账户/金额）
- [ ] 快捷金额/常用分类按钮

## 5. 流水列表与详情（P0）(Epic)

### 5.1 流水列表

- [ ] 列表数据源：按时间倒序获取
- [ ] 按日分组展示（日期 header）
- [ ] 条目样式：类型、金额、分类/转账方向、账户、时间、备注摘要
- [ ] 空状态：无数据引导去记一笔
- [ ] 下拉刷新（可选）
- [ ] 分页加载（可选）

### 5.2 搜索与筛选（P0）

- [ ] 搜索框：备注/商家/标签关键字
- [ ] 日期范围筛选（开始/结束）
- [ ] 金额区间筛选（最小/最大）
- [ ] 账户筛选（单选/多选）
- [ ] 分类筛选（单选；支持选择父级包含子级）
- [ ] 标签筛选（多选）
- [ ] 排序：时间/金额（可选）
- [ ] 筛选条件展示（chips）与一键清空

### 5.3 流水详情页

- [ ] 展示字段：类型、金额、账户、分类、时间、备注、标签、商家
- [ ] 转账展示：转出→转入
- [ ] 操作：编辑入口
- [ ] 操作：删除（确认弹窗）

### 5.4 编辑流水（P0）

- [ ] 复用“记一笔”页面为编辑模式
- [ ] 预填原数据
- [ ] 保存时调用编辑 UseCase（处理余额一致性）
- [ ] 编辑成功：回到详情/列表并刷新

### 5.5 删除流水（P0）

- [ ] 删除确认交互
- [ ] 调用删除 UseCase（处理余额一致性）
- [ ] 删除成功：返回列表并刷新

### 5.6 回收站（P1 可选）

- [ ] 软删除字段与查询过滤
- [ ] 回收站列表
- [ ] 还原/彻底删除

## 6. 账本与账户（P0）(Epic)

### 6.1 账本管理

- [ ] 账本列表页
- [ ] 新建账本（名称校验）
- [ ] 编辑账本
- [ ] 删除账本（含数据处理策略：禁止/二次确认/清空）
- [ ] 归档/取消归档（P1 可选）
- [ ] 设置默认账本

### 6.2 账户管理

- [ ] 账户列表页（显示余额、启用状态）
- [ ] 新建账户：名称、类型、初始余额、币种（MVP 单币种可隐藏）
- [ ] 编辑账户
- [ ] 启用/停用账户
- [ ] 余额调整：输入目标余额或调整值（口径明确）
- [ ] 账户详情：显示流水入口（按账户筛选）

### 6.3 账户间转账入口

- [ ] 从账户页进入转账（预填账户）
- [ ] 从记一笔页进入转账（默认无预填）

### 6.4 信用卡字段支持（P1/P2）

- [ ] 账单日/还款日/额度字段录入
- [ ] 信用卡账单提醒（与提醒模块联动）

## 7. 分类、标签、商家管理（P0/P1）(Epic)

### 7.1 分类管理（P0）

- [ ] 分类列表：收入/支出分栏
- [ ] 新建一级分类
- [ ] 新建二级分类（选择父级）
- [ ] 编辑分类名称
- [ ] 删除分类（存在引用时：禁止或提示迁移）
- [ ] 分类排序（拖拽或上下移，P1 可选）
- [ ] 常用置顶（P1 可选）

### 7.2 分类合并/迁移（P1）

- [ ] 选择源分类与目标分类
- [ ] 批量迁移关联流水
- [ ] 源分类删除或保留策略
- [ ] 迁移过程进度与失败回滚策略

### 7.3 标签管理（P0/P1）

- [ ] 标签列表
- [ ] 新建/编辑/删除标签
- [ ] 标签颜色/图标（P1 可选）
- [ ] 流水与标签关系存储（中间表或 JSON）

### 7.4 商家管理（P1）

- [ ] 商家列表
- [ ] 新建/编辑/删除商家
- [ ] 记账时商家联想（按历史输入前缀匹配）

## 8. 统计与报表（P0/P1）(Epic)

### 8.1 统计页面骨架

- [ ] 统计入口与页面布局（概览 Tab / 分类 Tab）
- [ ] 时间范围选择：本月/上月/近3月/自定义
- [ ] 统计计算 Loading 与空状态

### 8.2 概览（P0）

- [ ] 指标：收入/支出/结余
- [ ] 统计口径：排除转账
- [ ] 周期切换后刷新数据

### 8.3 分类统计（P0）

- [ ] 支出分类聚合（默认）
- [ ] 收入分类聚合切换
- [ ] Top N 列表
- [ ] 图表展示（饼图/条形图，先做条形图也可）
- [ ] 点击分类进入筛选后的流水列表

### 8.4 账户统计（P1）

- [ ] 账户余额趋势（按日/月采样）
- [ ] 净资产（资产-负债）口径定义与展示
- [ ] 现金流（可选）

### 8.5 标签/商家统计（P1/P2）

- [ ] 按标签聚合
- [ ] 按商家聚合
- [ ] 维度筛选与跳转流水

## 9. 预算与提醒（P1）(Epic)

### 9.1 预算模型与规则

- [ ] 预算周期：按月（MVP 先月）
- [ ] 总预算：金额设置与保存
- [ ] 分类预算：按分类设置（可选）
- [ ] 预算口径：仅统计支出

### 9.2 预算页面

- [ ] 预算列表（当前周期）
- [ ] 预算设置页（总预算/分类预算）
- [ ] 预算进度：已用/剩余/超支
- [ ] 按天建议可用额度（可选）

### 9.3 提醒（可选实现路径）

- [ ] 账单日/还款日提醒（信用卡）
- [ ] 定时记账提醒（系统通知）
- [ ] 通知权限申请与引导
- [ ] 提醒开关与时间设置

## 10. 数据导出、备份与恢复（P0）(Epic)

### 10.1 CSV 导出（P0）

- [ ] 确定导出字段（与 PRD 12.1 一致）
- [ ] 支持按账本导出
- [ ] 支持按时间范围导出（P1 可选）
- [ ] 文件命名规则（含日期与账本名）
- [ ] 使用 SAF 选择保存位置
- [ ] 导出完成提示与分享（可选）

### 10.2 备份（P0）

- [ ] 备份文件格式定义（JSON/ZIP，MVP 可先 JSON 单文件）
- [ ] 备份内容：账本/账户/分类/标签/商家/流水/拆分（如有）
- [ ] 备份生成：写入文件（SAF）
- [ ] 备份记录：展示最近备份列表
- [ ] 校验：checksum（P1 可选）

### 10.3 恢复（P0）

- [ ] 选择备份文件（SAF）
- [ ] 解析与校验（格式、版本、必要字段）
- [ ] 恢复策略：覆盖恢复（清空后导入）
- [ ] 恢复进度提示与结果提示
- [ ] 恢复失败处理（不破坏原数据：事务/临时库方案）

### 10.4 合并恢复（P1）

- [ ] 冲突定义（同 ID、同名称不同内容等）
- [ ] 合并策略（优先备份/优先本地/人工选择）
- [ ] 幂等导入（重复导入不产生重复）

## 11. 设置与个性化（P0/P1）(Epic)

### 11.1 记账偏好（P0）

- [ ] 默认账本选择
- [ ] 默认账户选择
- [ ] 小数位设置（或固定两位）
- [ ] 周起始日设置（P1）
- [ ] 时间格式设置（P1）

### 11.2 主题与显示（P1）

- [ ] 深色模式开关（跟随系统/常亮/常暗）
- [ ] 字体大小（可选）

## 12. 可选增强功能（P2）(Epic)

### 12.1 附件

- [ ] 流水附件选择（相册/拍照）
- [ ] 附件存储策略（私有目录/SAF）
- [ ] 附件预览与删除

### 12.2 退款/冲正

- [ ] 关联原流水选择
- [ ] 自动生成反向流水
- [ ] 关系展示与统计口径

### 12.3 分摊

- [ ] 成员管理（本地成员）
- [ ] 分摊规则（AA/自定义比例）
- [ ] 待结算清单与结算动作

### 12.4 定时记账与自动归类

- [ ] 定时任务模型（规则、下次执行时间）
- [ ] 系统调度（WorkManager）
- [ ] 自动归类规则（关键词/商家匹配）

### 12.5 快捷入口

- [ ] 桌面小组件（AppWidget）
- [ ] 快捷指令/快捷方式（Shortcuts）

### 12.6 多端同步与协作

- [ ] 登录体系（账号体系选择）
- [ ] 同步协议与冲突合并
- [ ] 共享账本与角色权限
- [ ] 操作日志

### 12.7 安全

- [ ] 本地解锁（PIN/生物识别）
- [ ] 本地加密存储（SQLCipher 等，按选型）

## 13. 验收用例清单（按模块）

### 13.1 P0 验收（最小集）

- [ ] 能新建账本并切换默认账本
- [ ] 能新建账户并看到余额变化
- [ ] 能新增支出/收入/转账流水且余额正确
- [ ] 能编辑/删除流水且余额与统计一致
- [ ] 能按日期/金额/账户/分类筛选流水
- [ ] 能看到本月概览与分类统计结果正确
- [ ] 能导出 CSV 并可在外部打开
- [ ] 能生成备份并覆盖恢复成功

### 13.2 P1/P2 验收（增强）

- [ ] 预算显示与超支提醒按口径正确
- [ ] 模板/批量操作提升记账效率
- [ ] 附件、分摊、定时/自动归类、同步、安全等能力可用

## 14. 执行顺序建议（可直接排期）

### 14.1 M1（建议 2~3 周）

- [ ] 基建完成（模块、Room、导航、基础组件）
- [ ] 记一笔（收入/支出/转账）全链路打通
- [ ] 流水列表/详情/编辑/删除打通
- [ ] 账户余额一致性策略落地并有测试覆盖

### 14.2 M2（建议 1~2 周）

- [ ] 统计（概览/分类）实现并可跳转筛选
- [ ] CSV 导出
- [ ] 备份/恢复（覆盖模式）

### 14.3 M3（建议 2 周）

- [ ] 预算 + 提醒（按优先级）
- [ ] 模板/复制上一笔/批量操作/回收站（按优先级）

### 14.4 M4（按资源评估）

- [ ] P2 增强按业务优先级逐项落地
